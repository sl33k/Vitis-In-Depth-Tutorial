## Step 3: Create the Vitis Platform


### Prepare Files for Platform Packaging

We'll prepare BIF file and the files it refers to into ***boot*** directory; we'll prepare all files needed for FAT32 partition to ***image*** directory.

1. Create boot directory and image directory

   ```bash
   cd zedboard_pkg/pfm
   mkdir boot image
   ```
   After this step, your directory hierarchy looks like this.

   ```
   - zedboard_platform # Vivado Project Directory
   - zedboard_plnx     # PetaLinux Project Directory
   - zedboard_pkg      # Platform Packaging Directory
     - pfm                  # Platform Packaging Sources
       - boot               # Platform boot components
       - image              # Files to be put in FAT32 partition
   ```

2. Copy the following files from ***zedboard_plnx/images/linux directory*** to the ***zedboard_pkg/pfm/boot*** directory to prepare for running the Vitis platform packaging flow:

   - zynq_fsbl.elf: rename to ***fsbl.elf*** as a workaround of a Vitis known issue.
   - u-boot.elf

Note: These files are the sources of creating BOOT.BIN.

3. Add a BIF file (linux.bif) to the ***zedboard/pfm/boot*** directory with the contents shown below. The file names should match the contents of the boot directory. The Vitis tool expands these pathnames relative to the sw directory of the platform at v++ link time or when generating an SD card. However, if the bootgen command is used directly to create a BOOT.BIN file from a BIF file, full pathnames in the BIF are necessary. Bootgen does not expand the names between the <> symbols.<br />

```
/* linux */
 the_ROM_image:
 {
 	[bootloader] <fsbl.elf>
 	<bitstream>
   <u-boot.elf>
 }
```

   - The file names in `<>` are placeholders. Vitis will replace the placeholders with the relative path to platform during platform packaging. V++ packager, which runs when buiding the final application would expand it further to the full path during image packaging.
   - Filename placeholders point to the files in boot directory. The filenames in boot directory need to match with placeholders in BIF file.
   - `<bitstream>` is a reserved keyword. V++ packager will replace it with the final system bit file.

4. Prepare image directory. Contents in this directory will be packaged to FAT32 partition by v++ package tool.

   a) Copy the follwing generated Linux software components from ***zedboard_plnx/images/linux directory*** to the ***zedboard_pkg/pfm/image*** directory.

   - boot.scr: script for u-boot initialization
   - system.dtb: device tree file for Linux to boot
   - uImage: the kernel image

   b) Create a ***init.sh*** file in the ***zedboard_pkg/pfm/image*** directory with the following contents:
   
   ```
   SCRIPTPATH=$(dirname $BASH_SOURCE)
   cp ${SCRIPTPATH}/platform_desc.txt /etc/xocl.txt
   export XILINX_XRT=/usr
   ```
   
   c) Create a ***platform_desc.txt*** in the ***zedboard_pkg/pfm/image*** directory with the following contents
   
   ```
   zedboard
   ```

   - init.sh will set environment variable XILINX_XRT for XRT and copy platform_desc.txt to /etc/xocl.txt
   - platform_desc.txt has the platform name. XRT OpenCL API can check the platform name before loading xclbin file to make sure they match.
   - User needs to run `source /mnt/sd-mmcblk0p1/init.sh` manually on the target platform.


### Create a Vitis Platform

First we create a Vitis platform project with the XSA file generated by Vivado from Step 1.

1. Go to the ***zedboard_pkg*** folder you created:

2. Launch Vitis by typing ```vitis``` in the console.

3. Select ***zedboard_pkg*** folder as workspace directory.

4. In the Vitis IDE, select ***File > New > Platform Project*** to create a platform project.<br />

5. Enter the project name. For this example, type ```zedboard```, click ***Next***.<br />

6. Select ***Create from hardware specification (XSA)*** and click ***Next***.<br />

7. In the Platform Project Specification page,

   a) Click ***Browse*** button, select the XSA file generated by the Vivado. In this case, it is ```zedboard_platform.xsa```.</br>
   b) Set the operating system to ***linux***.</br>
   c) Set the processor to ***ps7_cortexa9_0***.</br>
   e) ***Uncheck*** option ***Generate boot components***, because we'll use PetaLinux generated boot components.</br>
   f) Click ***Finish***.

Next we setup software settings in Platform Settings view.

1. In the Platform Settings view, observe the following:

   - The name of the Platform Settings view matches the platform project name of ***zedboard**.<br />
   - A psu_cortexa53 device icon is shown, containing a ***Linux on ps7_cortexa9*** domain.

2. Click the ***linux on ps7_cortexa9*** domain, browse to the locations and select the directory or file needed to complete the dialog box for the following:

   - ***Bif file***: Browse to ***zedboard_pkg/pfm/boot/linux.bif*** file and click OK.
   - ***Boot Components Direcotory***: Browse to ***zedboard_pkg/boot*** and click OK.
   - ***Linux Image Directory***: Browse to ***zedboard_pkg/image*** and click OK.


![vitis_linux_config.png](./images/vitis_linux_config.png)

4. Right-Click ***zedboard*** project in the Vitis Explorer view, and the select the ***Build Project*** Item to generate the platform.

***Note: The generated platform is placed in the export directory. BSP and source files are also provided for re-building the FSBLb if desired and are associated with the platform. The platform is ready to be used for application development.***

![](./images/vitis_platform_output.png)



If you'd create an Vitis application in the same workspace as this platform, you can find this platform available in the platform selection page in platform creation wizard. If you'd like to reuse this platform in another workspace, add its path to PLATFORM_REPO_PATHS environment variable before launching Vitis GUI, or use "Add" button in platform selection page of Vitis GUI to add its path.

***[Next let's try to build some applications on this platform and test them.](./step4.md)***

<p align="center"><sup>Copyright&copy; 2020 Xilinx</sup></p>
